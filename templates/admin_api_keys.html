{% extends "base.html" %}

{% block title %}API Key Management - WiseNews Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1><i class="fas fa-shield-alt"></i> WiseNews API Management</h1>
    
    <div class="row">
        <div class="col-md-12">
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="applications-tab" data-toggle="tab" href="#applications" role="tab">
                        <i class="fas fa-inbox"></i> API Applications ({{ applications|length }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="usage-tab" data-toggle="tab" href="#usage" role="tab">
                        <i class="fas fa-chart-line"></i> Usage Statistics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="logs-tab" data-toggle="tab" href="#logs" role="tab">
                        <i class="fas fa-list"></i> Access Logs
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="blocked-tab" data-toggle="tab" href="#blocked" role="tab">
                        <i class="fas fa-ban"></i> Blocked Access
                    </a>
                </li>
            </ul>
            
            <div class="tab-content" id="adminTabContent">
                <!-- API Applications Tab -->
                <div class="tab-pane fade show active" id="applications" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header stable-header">
                            <h5><i class="fas fa-inbox"></i> API Key Applications</h5>
                        </div>
                        <div class="card-body stable-card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Key Name</th>
                                            <th>Email</th>
                                            <th>Organization</th>
                                            <th>Created</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for app in applications %}
                                        <tr>
                                            <td><strong>{{ app[1] }}</strong></td>
                                            <td>{{ app[3] }}</td>
                                            <td>{{ app[4] or 'N/A' }}</td>
                                            <td>{{ app[5] }}</td>
                                            <td>
                                                {% if app[6] == 'pending' %}
                                                    <span class="badge badge-warning">Pending</span>
                                                {% elif app[6] == 'active' %}
                                                    <span class="badge badge-success">Active</span>
                                                {% else %}
                                                    <span class="badge badge-secondary">{{ app[6] }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if app[6] == 'pending' %}
                                                <button class="btn btn-sm btn-success stable-btn" onclick="approveKey('{{ app[2] }}')">
                                                    <i class="fas fa-check"></i> Approve
                                                </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-info stable-btn" onclick="showKeyDetails('{{ app[2] }}', '{{ app[1] }}', '{{ app[3] }}')">
                                                    <i class="fas fa-eye"></i> Details
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Usage Statistics Tab -->
                <div class="tab-pane fade" id="usage" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header stable-header">
                            <h5><i class="fas fa-chart-line"></i> API Usage Statistics</h5>
                        </div>
                        <div class="card-body stable-card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Key Name</th>
                                            <th>Email</th>
                                            <th>Total Requests</th>
                                            <th>Last Used</th>
                                            <th>Rate Limit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for stat in usage_stats %}
                                        <tr>
                                            <td>{{ stat[0] }}</td>
                                            <td>{{ stat[1] }}</td>
                                            <td><span class="badge badge-primary">{{ stat[2] }}</span></td>
                                            <td>{{ stat[3] or 'Never' }}</td>
                                            <td>{{ stat[4] }}/hour</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Access Logs Tab -->
                <div class="tab-pane fade" id="logs" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header stable-header">
                            <h5><i class="fas fa-list"></i> Recent API Access</h5>
                        </div>
                        <div class="card-body stable-card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Key Name</th>
                                            <th>Endpoint</th>
                                            <th>IP Address</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for log in recent_usage %}
                                        <tr>
                                            <td>{{ log[3] }}</td>
                                            <td>{{ log[4] }}</td>
                                            <td><code>{{ log[1] }}</code></td>
                                            <td>{{ log[2] }}</td>
                                            <td><span class="badge badge-success">200</span></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Blocked Access Tab -->
                <div class="tab-pane fade" id="blocked" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header stable-header">
                            <h5><i class="fas fa-ban"></i> Blocked Access Attempts</h5>
                        </div>
                        <div class="card-body stable-card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>IP Address</th>
                                            <th>User Agent</th>
                                            <th>Reason</th>
                                            <th>Blocked Time</th>
                                            <th>Auto Block</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for blocked in blocked_access %}
                                        <tr>
                                            <td><code>{{ blocked[0] }}</code></td>
                                            <td><small>{{ blocked[1][:50] }}...</small></td>
                                            <td>{{ blocked[2] }}</td>
                                            <td>{{ blocked[3] }}</td>
                                            <td>
                                                {% if blocked[4] %}
                                                    <span class="badge badge-warning">Auto</span>
                                                {% else %}
                                                    <span class="badge badge-danger">Manual</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Manual Block</h6>
                                <form id="blockForm" class="form-inline" class="stable-form">
                                    <input type="hidden" name="admin_key" value="wisenews_admin_2025">
                                    <input type="text" name="ip_address" class="form-control mr-2 stable-input" placeholder="IP Address">
                                    <input type="text" name="user_agent" class="form-control mr-2 stable-input" placeholder="User Agent">
                                    <input type="text" name="reason" class="form-control mr-2 stable-input" placeholder="Reason">
                                    <button type="submit" class="btn btn-danger stable-btn">
                                        <i class="fas fa-ban"></i> Block
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Approval Modal -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title stable-title">Approve API Key</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="approveForm" class="stable-form">
                    <input type="hidden" name="admin_key" value="wisenews_admin_2025">
                    <input type="hidden" name="api_key" id="approveApiKey">
                    <div class="form-group stable-form-group">
                        <label class="stable-label">Rate Limit (requests per hour)</label>
                        <select name="rate_limit" class="form-control">
                            <option value="100">100 (Free Tier)</option>
                            <option value="1000">1,000 (Premium)</option>
                            <option value="10000">10,000 (Enterprise)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary stable-btn" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success stable-btn" onclick="confirmApproval()">Approve</button>
            </div>
        </div>
    </div>
</div>

<script>
function approveKey(apiKey) {
    document.getElementById('approveApiKey').value = apiKey;
    $('#approveModal').modal('show');
}

function confirmApproval() {
    const form = document.getElementById('approveForm');
    const formData = new FormData(form);
    
    fetch('/admin/approve-key', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('API key approved successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
        $('#approveModal').modal('hide');
    })
    .catch(error => {
        alert('Error approving key');
        $('#approveModal').modal('hide');
    });
}

function showKeyDetails(apiKey, keyName, email) {
    alert(`API Key Details:\n\nKey: ${apiKey}\nName: ${keyName}\nEmail: ${email}`);
}

// Block form submission
document.getElementById('blockForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/admin/block-access', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Access blocked successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error blocking access');
    });
});
</script>
{% endblock %}
